---
- name: Update apt cache and install prerequisites
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - software-properties-common
      - wget
    state: present
    update_cache: true
- name: Ensure /etc/apt/keyrings directory exists
  ansible.builtin.file:
    mode: "0755"
    path: /etc/apt/keyrings/
    state: directory
- name: Download Grafana GPG key and dearmor it
  ansible.builtin.shell:
    cmd: >-
      wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | tee
      /etc/apt/keyrings/grafana.gpg > /dev/null
    creates: /etc/apt/keyrings/grafana.gpg
- name: Add Grafana apt repository
  ansible.builtin.apt_repository:
    filename: grafana
    repo: >-
      deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com
      stable main
    state: present
    update_cache: true
- name: Install Grafana
  ansible.builtin.apt:
    name: grafana
    state: present
- name: Reload systemd daemon
  ansible.builtin.systemd_service:
    daemon_reload: true
- name: Enable and start Grafana service
  ansible.builtin.systemd_service:
    enabled: "yes"
    name: grafana-server
    state: started
- name: Set http_port in grafana.ini
  ansible.builtin.ini_file:
    backup: true
    option: http_port
    path: /etc/grafana/grafana.ini
    section: server
    value: "{{ grafana_http_port }}"
- name: Configure anonymous authentication in grafana.ini
  ansible.builtin.ini_file:
    backup: true
    option: enabled
    path: /etc/grafana/grafana.ini
    section: auth.anonymous
    value: "false"
- name: Configure user signup in grafana.ini
  ansible.builtin.ini_file:
    backup: true
    option: allow_sign_up
    path: /etc/grafana/grafana.ini
    section: users
    value: "false"
- name: Restart Grafana service
  ansible.builtin.systemd_service:
    enabled: "yes"
    name: grafana-server
    state: restarted
- name: Verify Grafana endpoint
  ansible.builtin.uri:
    method: GET
    status_code: 200
    url: http://localhost:{{ grafana_http_port }}
  become: "yes"
  delay: 10
  retries: 5
